
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Calendar Booking System</title>

        <!-- JQuery & JQuery UI  -->
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                padding: 0;
                background-color: #f4f4f9;
            }

            label {
                margin-right: 10px;
            }

            select, button {
                margin-right: 20px;
                padding: 5px 10px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }

            #slotsContainer {
                margin-top: 20px;
                display: flex;
                flex-wrap: wrap;
            }

            .slot {
                padding: 10px;
                margin: 5px;
                background-color: #e2e2e2;
                border-radius: 5px;
                cursor: pointer;
                user-select: none;
            }

        </style>

    </head>


    <body>

        <h1>Book a Meeting</h1>
        <div>
            <div>
                <label for="datePicker">Select a Date:</label>
                <input type="text" id="datePicker" readonly>
            
                <label for="durationSelect">Duration:</label>
                <select id="durationSelect">
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                </select>
            
                <button id="loadSlots">Load Available Slots</button>
            </div>
            <div id="slotsContainer"></div>    
        </div>
    

        <script src="Utils.js"></script>
        <script src="Day.js"></script>
        <script src="EventEntry.js"></script>

        <script>
            const cs = console.log


            
            const day_mapping = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]

            const HOUR_CONFIG = {
                "daily" : {
                    "start" : "05:00",
                    "end"   : "23:00",
                },
                // "weekend" : {
                //     "start" : "09:00",
                //     "end"   : "23:00",
                // },
                // "Saturday" : {
                //     "start" : "10:00",
                //     "end"   : "11:00",
                // },
            }

            const DATE_BASED_HOUR_CONFIG = {
                "2024-04-22" : {
                    "start" : "10:30",
                    "end"   : "11:00",
                }
            }

            const EVENT_TYPES = {
                "fitness" : {
                    "padding" : {
                        "before" : 30,
                        "after"  : 30,
                    }
                }
            }






            function get_events(){
                let events = [];
                    $.ajax({
                    url: "ajax.php",
                    type: "POST",
                    data: { type: "get_events" },
                    async: false,  // This makes the AJAX request synchronous
                    success: function(data) {
                        let parsed = JSON.parse(data)
                        parsed.forEach(item => {
                            events.push(new EventEntry(new Day(item.day.day), item.start, item.end))
                        });
                    }
                });
                return events
            }



            function get_day_availability_range(
                day
            ){

                let config = HOUR_CONFIG.daily;

                if(HOUR_CONFIG.weekend && day.is_weekend){
                    config = HOUR_CONFIG.weekend;
                }
                if(HOUR_CONFIG[day.dow]){
                    config = HOUR_CONFIG[day.dow];                    
                }
                
                if(DATE_BASED_HOUR_CONFIG[day.day]){
                    config = DATE_BASED_HOUR_CONFIG[day.day];                    
                }

                return [
                    Utils.time_to_minutes(config.start),
                    Utils.time_to_minutes(config.end),                    
                ];
            }


            $(document).ready(function() {

                $("#datePicker").datepicker({
                    dateFormat: "yy-mm-dd"
                }).
                datepicker("setDate", new Date());


                // Button click to load available slots based on selected date and duration
                $("#loadSlots").click(function() {
                    const dateText = $("#datePicker").val();
                    const duration = parseInt($("#durationSelect").val(), 10);
                    if (dateText) {
                        displayAvailableSlots(new Day(dateText), duration);
                    } else {
                        alert("Please select a date first.");
                    }
                });
            });



            function displayAvailableSlots(
                day,
                duration
            ){
                events = get_events();

                // reset every time it loads
                let slotContainer = document.getElementById("slotsContainer")
                slotContainer.innerHTML = ""

                let [start_time, end_time] = get_day_availability_range(day);

                while(start_time + duration < end_time){

                    let start = start_time;
                    let end = start_time + duration;

                    if(slot_available(new EventEntry(day, start, end))){

                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'slot';
                        let display_start = Utils.minutes_to_time(start)
                        let display_end = Utils.minutes_to_time(end)
                        slotDiv.textContent = `${display_start} - ${display_end}`;


                        slotDiv.onclick = function (){
                            if(!add_event(day, start, end)){                            
                                alert("Slot Unavailable")
                            }
                            displayAvailableSlots(day, duration)
                        }
                        slotsContainer.appendChild(slotDiv);
                    }

                    start_time += duration;
                }


            }


            function add_event(
                day,
                event_start,
                event_end                
            ){
                let event_entry = new EventEntry(day, event_start, event_end)
                if(slot_available(event_entry)){
                    events.push(event_entry);
                    $.post( "ajax.php", {
                        type: "update",
                        events: events
                    }, function( data ) {
                        cs(data)
                    });

                    return true
                }
                return false
            }

       

        
        function slot_available(
                new_event
            ){
                for (let event of events) {
                    if (
                        event.day.day === new_event.day.day
                            && 
                        timesOverlap(event.start, event.end, new_event.start, new_event.end)
                    ) {
                        return false;
                    }
                }
                return true;
            }
            

            function timesOverlap(start1, end1, start2, end2) {
                return !(end1 <= start2 || end2 <= start1);
            }








        </script>
        
    </body>
</html>